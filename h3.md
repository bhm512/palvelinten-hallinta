# h3

## Muistiinpanot:

https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/

- Vagrant siis automaattisesti asentaa virtuaalikoneita VirtualBoxiin, sekä käyttää automatisoi SSH- kirjautumisen.
- EI tarvitse käyttää graaffista käyttöliittymää.
- Voi luoda ja poistaa virtuaalikoneita nopeasti.


https://terokarvinen.com/2018/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/?fromSearch=salt%20quickstart%20salt%20stack%20master%20and%20slave%20on%20ubuntu%20linux

- Salt mahdollistaa tuhanisen koneiden hallinan yhdestä masterista, ainoastaan masterin IP-osoitteen tulee olla julkinen.
- Jokaisella orjalla on oltava eri tunnus, joten live-USB:lle tunnusparametri on pakollinen.
- Voit luoda eri tiloja isäntä-orja infrastruktuurille, kun se toimii. Tilat ovat tiedostoja, jotka määrittelevät orjien kohdetilat.


  https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file

  - Konfiguraatioiden hallinnan avulla voit hallita satoja tietokoneita, myös sellaisia joita ei ole vielä olemassa
  - Idempotentit komennot ovat tehokkaampia. Ne kuvaavat vain lopputilan ja Salt tekee muutoksia vain tarvittaessa.
 
## h1

Ensiksi asensin vagrantin komennolla: sudo apt install vagrant
Jotta sain vagrantin asennettua käytin vielä komentoja: vagrant plugin install vagrant-libvirt , ja : sudo apt install -y vagrant vagrant-libvirt libvirt-daemon-system qemu-kvm virt-manager
Tuossa vagrantin versio: 


<img width="465" height="61" alt="Näyttökuva 2025-11-05 kello 16 11 07" src="https://github.com/user-attachments/assets/657279f9-b97b-49bf-ba30-fb72960b6ae3" />

## h2

Toisessa kohdassa yritin luoda Vagrantin avulla uuden virtuaalikoneen, mutta se osottautui ajateltua vaikeammaksi. Uskaltaisin jo tässä vaiheessa arvata, että syynä olisi oma koneeni (Mac M2 sirulla), sillä siinä on ARM- prosesessori. 

- x86_64 (Intel/AMD) ja ARM64 (Apple Silicon) ovat täysin eri arkkitehtuureja
- Käskyt, joita x86-ohjelmat käyttävät, eivät ole yhteensopivia ARM:n kanssa.
- Siksi x86-ohjelmia pitää emuloida (QEMU tekee tämän UTM:ssä), mutta se ei tue kaikkia CPU-laajennuksia — kuten virtualisointia.

Eli: kun Vagrant yrittää ajaa virtuaalikonetta, se tarvitsee virtualisointitukea (VT-x/AMD-V), mutta ARM-prosessorilla sitä ei voi emuloida täydellisesti.

Tässä kaikki mitä kokeilin: 

<img width="1464" height="824" alt="Näyttökuva 2025-11-09 kello 17 44 58" src="https://github.com/user-attachments/assets/04baa5aa-ba35-4d9e-93a5-40c513edd5da" />

Tuon sain aikaan, tällä:

<img width="514" height="457" alt="Näyttökuva 2025-11-09 kello 17 46 27" src="https://github.com/user-attachments/assets/2a660da7-21d1-4b6c-85e1-d81bd3b3b56f" />

Vaikka ei punaista error tekstiä vielä tullut ei kone myöskään toiminut: 
Katsoin sen komennolla: virsh list --all

<img width="474" height="100" alt="Näyttökuva 2025-11-09 kello 17 51 00" src="https://github.com/user-attachments/assets/37406c92-5ff3-4384-898a-589be4fef258" />

Yritin muokata vielä Vagrantfilea monta kertaa, mutta tuloksetta. 

Välillä myös sain ristiriitaisia tietoja kun yritin käynnistää ja päivittää konetta:

<img width="617" height="68" alt="Näyttökuva 2025-11-09 kello 19 01 45" src="https://github.com/user-attachments/assets/8c5c86e0-29de-499e-a55e-6229a4d8b539" />


<img width="1470" height="83" alt="Näyttökuva 2025-11-09 kello 19 04 09" src="https://github.com/user-attachments/assets/8c828aa2-67ca-4169-85d0-680daea97c7d" />

Koitin seuraavaksi poistaa apparmorin, josta epäilin virheen johtuvan: 


<img width="760" height="363" alt="Näyttökuva 2025-11-09 kello 19 13 03" src="https://github.com/user-attachments/assets/35e92e8c-d558-4034-bd12-21025b88d7ac" />

Mutta sekään ei auttanut: 


<img width="1459" height="618" alt="Näyttökuva 2025-11-09 kello 19 14 06" src="https://github.com/user-attachments/assets/e9348467-9d48-43b8-befa-41a0713d2fbe" />

Lopputuloksena Vagrant kyllä toimii ARM:lla, mutta sen libvirt-provider (jota käytin UTM:n sisällä) tarvitsee täydet kernelin virtualisointiominaisuudet (KVM), jotka eivät ole saatavilla UTM:n sisällä.

## h3 

Ei onnistunut: 

Vagrantin pitäisi pystyä luomaan useita virtuaalikoneita, jotka jakavat virtuaaliverkon (libvirt network).

Tämä perustuu siihen, että libvirt voi luoda virtuaalisen silta- tai NAT-verkon (virbr0). 

Miksi ei onnitunut?

Koska UTM:n sisäinen Debian ei tue KVM:ää, libvirt joutuu käyttämään puhdasta QEMU-emulaatiota.

Tässä tilassa libvirt ei saa luotua toimivaa virtuaaliverkkoa (“user network”) ilman KVM-tukea.
Siksi ping tai yhteydet koneiden välillä eivät onnistu.

## h4

Tehtävässä haluttiin: Kaksi erillistä virtuaalikonetta, jotka voivat kommunikoida keskenään (esim. ping + TCP-portti 4505/4506).

Salt-masterin ja -minionin yhteys riippuu toimivasta verkosta.

Ei onnistunut koska: 

Koska kohtaa (c) ei voi toteuttaa, et voi luoda kahta koneellista verkkoa, eikä Salt voi kommunikoida.

Lisäksi Vagrantin SSH ei toimi luotettavasti ilman täydellistä libvirtin virtualisointia (koska AppArmor, UEFI ja PS/2/USB-virheet estävät koneen luomisen).

## h5

Viimeisessä kohdassa haluttiin: Toimiva Salt master/minion -verkko.

Mahdollisuus siirtää ja ajaa komentoja verkon yli. 

Ei onnitunut koska: 

Kun (d) ei toimi, et pääse tähän vaiheeseen.
Saltin tiloja (pkg, file, service, user, cmd) ei voi ajaa, koska ei ole yhteyttä masterin ja minionin välillä.


Lopputuloksena voin sanoa, että pitäisi varmaan ostaa uusi kone.

